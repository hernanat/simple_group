# SimpleGroup

## About

Web application for the Pasc.al math community. TODO: more about.

## Deployment

At this point in time, this application assumes a postgres database. If you are not
  using postgres, you will have to fill in the blanks.

### ElasticBeanstalk

If you are interested in deploying the app to ElasticBeanstalk using our mechanism for doing so,
  follow the below steps. Note that this assumes that you have already configured a database for
  your application. See the note on connecting your application to an RDS database if you're using
  RDS.

This guide also assumes that you have either created or imported an SSL certificate using Amazon's
  Certificate Manager. If you haven't done that, stop now and go read their guides for doing so.

#### Getting an environment and sample application up

1.) Go to the ElasticBeanstalk console and click on *Create a new environment*

2.) Select *Web server environment* and press the *Select* button.

3.) Fill out the application and environment name information. Choose a subdomain that you want
    your environment to live on, or leave it blank for an autogenerated one.

4.) Select *Managed Platform* and then select *Docker* from the platform dropdown

5.) Select *Docker running on 64bit Amazon Linux 2* from the platform branch dropdown

    - if you want to use a different OS feel free. At the time of this writing, the aforementioned
      version is the latest one

6.) For application code, select *Sample Application*

7.) Click on *Configure more options*

8.) Under *Presets* select *High availability*

8.) (Optional) Under *Capacity* configure your desired capacity options

10.) (Optional) Under *Security* click *Edit* and add your EC2 key pair for SSHing into the machine

11.) Click *Create environment* at the bottom to create the environment. Wait for it to start up. Take
      note of the identifier of the load balancer that gets created.

It will take a while for the environment and application to start up. Once it's complete, move on to
  the next section.

#### Forwarding HTTPS requests to the app container

Go back to the configuration page and to the edit page for the load balancer configuration.

1.) Click on *Add Listener* and for the port put *443* and for the protocol select *HTTPS*

2.) Choose your SSL certificate and select an SSL policy (we use *ELBSecurityPolicy-2016-08*)

3.) *Add*

4.) Click *Apply*

Once the environment configuration task completes, move on to the next section.

#### Forcing SSL

Navigate to the EC2 console. From the console dashboard, click *Load balancers* and locate the load balancer
  that was created for your application.

1.) Select the load balancer and then click *Listeners* at the bottom

2.) Select the HTTP port 80 listener and click *Edit*

3.) Under *Default actions*, click the trash can next to the existing action.

4.) Click *Add action* and select *Redirect to*

5.) Select *HTTPS* and enter *443* for the port number

6.) Click the blue checkmark

7.) Click *Update* at the top.

This will force all http connections to be redirected to an https connection.

#### Setting environment variables

Now we need to configure our environment variables for when we deploy our application code. To do this you can:

1.) Go to *Configuration > Software* for your environment and fill in *Environment properties* at the bottom

2.) Use the EB CLI to set them.

To use the EB CLI, make sure you have it installed and do the following:

1.) Put all your production environment variables into a `.env.prod` file

2.) run `eb init` in your application directory. Select the region that your EB environment
    is in, and then select your application name

3.) For CodeCommit select `N`

Now run `eb printenv`. It should complete with no errors and be empty.

Run the following:

```
eb setenv `cat .env.prod | sed '/^#/ d' | sed '/^$/ d'\`
```

This will set the appropriate environment variables for your application. Run `eb printenv` again
  to verify.

#### Security groups for databases hosted on RDS

In order to allow your app to talk to your RDS database, you need to make sure that your security
  groups are configured properly. Follow the guide [here](https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/rds-external-defaultvpc.html) to do so.

#### Deploy

Finally, to deploy to EB, run:

```
bin/eb-deploy <eb-environment-name> <docker-image-name>
```

See the deploy script source itself for examples.
